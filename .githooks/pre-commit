#!/bin/bash
# Pre-commit hook: Auto-format C++ files with clang-format

# Find all staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp)$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check if clang-format is available (either locally or via Docker)
if command -v clang-format &> /dev/null; then
    # Use local clang-format
    echo "Formatting staged files with clang-format..."
    echo "$STAGED_FILES" | xargs clang-format -i
elif command -v docker &> /dev/null; then
    # Use Docker image
    echo "Formatting staged files with clang-format (Docker)..."
    for file in $STAGED_FILES; do
        docker run --rm -v "$(pwd):/workspace" ghcr.io/orhanveliesen/hft-builder:latest \
            sh -c "cd /workspace && clang-format -i $file"
    done
else
    echo "Warning: clang-format not found. Skipping formatting."
    exit 0
fi

# Re-add formatted files
echo "$STAGED_FILES" | xargs git add

echo "âœ“ Code formatted successfully"
exit 0
