<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFT Dashboard</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --accent-green: #00d26a;
            --accent-red: #ff6b6b;
            --accent-blue: #4cc9f0;
            --accent-yellow: #ffd93d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--bg-card);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--bg-card);
        }

        .card h2 {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric {
            font-size: 2rem;
            font-weight: 700;
        }

        .metric.positive {
            color: var(--accent-green);
        }

        .metric.negative {
            color: var(--accent-red);
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--bg-card);
        }

        th {
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: var(--bg-card);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.enabled {
            background: rgba(0, 210, 106, 0.2);
            color: var(--accent-green);
        }

        .badge.disabled {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
        }

        .badge.buy {
            background: rgba(0, 210, 106, 0.2);
            color: var(--accent-green);
        }

        .badge.sell {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-card);
        }

        .event-type {
            width: 80px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            color: var(--accent-blue);
        }

        .event-symbol {
            width: 100px;
            font-weight: 500;
        }

        .event-details {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .event-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .tuner-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refreshing {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>HFT Dashboard</h1>
            <div class="status-indicator">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Disconnected</span>
                <span id="refresh-indicator"></span>
            </div>
        </header>

        <div id="error-container"></div>

        <!-- Portfolio Overview -->
        <div class="grid">
            <div class="card">
                <h2>Cash Balance</h2>
                <div class="metric" id="cash-balance">-</div>
                <div class="metric-label">Available Capital</div>
            </div>
            <div class="card">
                <h2>Session P&L</h2>
                <div class="metric" id="session-pnl">-</div>
                <div class="metric-label">Realized + Unrealized</div>
            </div>
            <div class="card">
                <h2>Total Equity</h2>
                <div class="metric" id="total-equity">-</div>
                <div class="metric-label">Cash + Positions</div>
            </div>
        </div>

        <!-- Symbols & Positions -->
        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <h2>Symbol Configurations</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Status</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>P&L</th>
                                <th>EMA Dev</th>
                                <th>Position %</th>
                            </tr>
                        </thead>
                        <tbody id="symbols-table">
                            <tr><td colspan="7" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2>AI Tuner Stats</h2>
                <div class="tuner-stats" id="tuner-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="tuner-decisions">-</div>
                        <div class="stat-label">Decisions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tuner-changes">-</div>
                        <div class="stat-label">Config Changes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tuner-latency">-</div>
                        <div class="stat-label">Avg Latency</div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="triggerTune()">Trigger Tune</button>
                </div>
            </div>
        </div>

        <!-- Events -->
        <div class="card">
            <h2>Recent Events</h2>
            <div class="events-list" id="events-list">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let refreshInterval;

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            return value.toFixed(1) + '%';
        }

        // Update status indicator
        function updateStatus(connected, message) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');

            dot.classList.toggle('connected', connected);
            text.textContent = message;
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Clear error
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        // Fetch status
        async function fetchStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/status`);
                const data = await res.json();

                const hftOk = data.hft?.heartbeat_ok;
                updateStatus(hftOk, hftOk ? 'HFT Running' : 'HFT Offline');

                clearError();
            } catch (e) {
                updateStatus(false, 'API Error');
                showError('Failed to connect to API server');
            }
        }

        // Fetch portfolio
        async function fetchPortfolio() {
            try {
                const res = await fetch(`${API_BASE}/api/portfolio`);
                const data = await res.json();

                document.getElementById('cash-balance').textContent = formatCurrency(data.cash || 0);

                const pnl = (data.total_realized_pnl || 0) + (data.total_unrealized_pnl || 0);
                const pnlEl = document.getElementById('session-pnl');
                pnlEl.textContent = formatCurrency(pnl);
                pnlEl.className = 'metric ' + (pnl >= 0 ? 'positive' : 'negative');

                document.getElementById('total-equity').textContent = formatCurrency(data.total_equity || 0);
            } catch (e) {
                console.error('Failed to fetch portfolio:', e);
            }
        }

        // Fetch symbols
        async function fetchSymbols() {
            try {
                const res = await fetch(`${API_BASE}/api/symbols`);
                const data = await res.json();

                const tbody = document.getElementById('symbols-table');

                if (!data.symbols || data.symbols.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No symbols configured</td></tr>';
                    return;
                }

                tbody.innerHTML = data.symbols.map(s => `
                    <tr>
                        <td><strong>${s.symbol}</strong></td>
                        <td>
                            <span class="badge ${s.enabled ? 'enabled' : 'disabled'}">
                                ${s.enabled ? 'Active' : 'Paused'}
                            </span>
                        </td>
                        <td>${s.performance?.total_trades || 0}</td>
                        <td>${formatPercent(s.performance?.win_rate || 0)}</td>
                        <td class="${(s.performance?.total_pnl || 0) >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(s.performance?.total_pnl || 0)}
                        </td>
                        <td>${formatPercent(s.config?.ema_dev_trending_pct || 0)}</td>
                        <td>${formatPercent(s.config?.base_position_pct || 0)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch symbols:', e);
            }
        }

        // Fetch stats
        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                document.getElementById('tuner-decisions').textContent =
                    data.tuner?.total_decisions || 0;
                document.getElementById('tuner-changes').textContent =
                    data.tuner?.config_changes || 0;
                document.getElementById('tuner-latency').textContent =
                    (data.tuner?.avg_latency_ms || 0).toFixed(0) + 'ms';
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        // Fetch events
        async function fetchEvents() {
            try {
                const res = await fetch(`${API_BASE}/api/events?limit=20`);
                const data = await res.json();

                const list = document.getElementById('events-list');

                if (!data.events || data.events.length === 0) {
                    list.innerHTML = '<div class="loading">No events yet</div>';
                    return;
                }

                list.innerHTML = data.events.slice().reverse().map(e => `
                    <div class="event-item">
                        <div class="event-type">${e.type}</div>
                        <div class="event-symbol">${e.symbol || '*'}</div>
                        <div class="event-details">${formatEventDetails(e)}</div>
                        <div class="event-time">#${e.sequence}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to fetch events:', e);
            }
        }

        // Format event details
        function formatEventDetails(event) {
            if (event.trade) {
                const side = event.trade.side === 'BUY' ?
                    '<span class="badge buy">BUY</span>' :
                    '<span class="badge sell">SELL</span>';
                return `${side} ${event.trade.quantity.toFixed(4)} @ ${formatCurrency(event.trade.price)}`;
            }
            if (event.config_change) {
                return `${event.config_change.param}: ${event.config_change.old_value} â†’ ${event.config_change.new_value}`;
            }
            if (event.ai) {
                return `Decision (conf: ${event.ai.confidence}%, latency: ${event.ai.latency_ms}ms)`;
            }
            if (event.reason) {
                return event.reason;
            }
            return '-';
        }

        // Trigger manual tuning
        async function triggerTune() {
            try {
                const res = await fetch(`${API_BASE}/api/tune`, { method: 'POST' });
                const data = await res.json();
                alert(data.message || 'Tuning requested');
            } catch (e) {
                alert('Failed to trigger tuning');
            }
        }

        // Refresh all data
        async function refreshAll() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.textContent = '(refreshing...)';
            indicator.classList.add('refreshing');

            await Promise.all([
                fetchStatus(),
                fetchPortfolio(),
                fetchSymbols(),
                fetchStats(),
                fetchEvents()
            ]);

            indicator.textContent = '';
            indicator.classList.remove('refreshing');
        }

        // Initialize
        async function init() {
            await refreshAll();
            refreshInterval = setInterval(refreshAll, 5000);
        }

        init();
    </script>
</body>
</html>
